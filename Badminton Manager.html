<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badminton Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
        :root {
            --bg: #f1f5f9; --card: #ffffff; --primary: #2563eb; --dark: #1e293b;
            --male: #3b82f6; --female: #ec4899; --danger: #ef4444; --reserved: #f59e0b;
            --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            --success: #10b981;
        }
        * { box-sizing: border-box; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--dark); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* --- Header --- */
        .header { 
            background: #fff; padding: 0 15px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; z-index: 10;
        }
        .logo { font-size: 1.2rem; font-weight: 900; color: var(--primary); display: flex; align-items: center; gap: 6px; }
        .h-btn-group { display: flex; gap: 8px; align-items: center; }
        
        .h-btn {
            height: 36px; padding: 0 12px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;
            border: 1px solid #cbd5e1; background: #fff; color: var(--dark); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap;
        }
        .h-btn.primary { background: var(--primary); color: #fff; border: none; }
        .h-btn:active { transform: scale(0.96); }

        /* --- Main Layout --- */
        .main-container { 
            display: grid; 
            grid-template-columns: 280px 1fr; 
            gap: 20px; 
            padding: 20px; 
            height: calc(100vh - 60px); 
            overflow: hidden;
        }

        /* --- Sidebar (Waiting Court) --- */
        .waiting-court { 
            background: #fff; border-radius: 12px; border: 1px solid var(--border); 
            display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow);
            order: 1; 
        }
        .wc-header { 
            padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid var(--border); 
            display: flex; flex-direction: column; gap: 10px; flex-shrink: 0;
            position: sticky; top: 0; z-index: 5;
        }
        .wc-title-row { display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .search-input { width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.9rem; background: #fff; outline: none; }
        .wc-list { flex: 1; overflow-y: auto; padding: 10px; display: grid; gap: 8px; align-content: start; }

        /* --- Court Area --- */
        .court-area { 
            overflow-y: auto; 
            padding-bottom: 60px; 
            order: 2; 
        }
        .court-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }

        /* --- Responsive --- */
        @media (max-width: 1024px) { 
            .main-container { padding: 10px; } 
        }

        @media (max-width: 768px) { 
            .main-container { 
                grid-template-columns: 1fr; 
                grid-template-rows: 1fr 300px;
                gap: 10px;
                padding: 10px;
            } 
            .court-area { order: 1; padding-bottom: 10px; }
            .court-grid { grid-template-columns: 1fr; }
            .waiting-court { display: flex !important; order: 2; border-top: 2px solid var(--border); }
        }

        .court-card { background: #fff; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
        .cc-header { padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .type-select { padding: 4px 8px; border-radius: 6px; border: 1px solid #cbd5e1; font-weight: 700; font-size: 0.85rem; background: #f8fafc; }

        .game-section { padding: 15px; display: flex; flex-direction: column; justify-content: center; min-height: 160px; position: relative; }
        .next-section { background: #f8fafc; padding: 12px 15px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        
        .section-label { font-size: 0.75rem; font-weight: 900; color: #94a3b8; letter-spacing: 1px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        
        .timer-badge { 
            font-variant-numeric: tabular-nums; 
            background: #ecfdf5; color: #059669; 
            border: 1px solid #a7f3d0; 
            padding: 4px 10px; border-radius: 20px; 
            font-size: 0.9rem; font-weight: 800; 
            display: none; align-items: center; gap: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .player-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .player-chip { background: #fff; border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.03); transition: 0.2s; user-select: none; }
        .player-chip:active { transform: scale(0.96); background: #f1f5f9; }
        .waiting-chip { flex-direction: row; justify-content: space-between; padding: 10px 12px; }
        .next-chip { padding: 10px; font-size: 0.9rem; background: #fff; border: 1px dashed #cbd5e1; box-shadow: none; }
        
        .manual-chip { border: 2px solid transparent; opacity: 0.8; transition: all 0.2s; }
        .manual-chip.selected { 
            border-color: var(--primary); 
            background: #eff6ff; 
            opacity: 1; 
            box-shadow: 0 0 0 1px var(--primary);
        }

        .badge { font-size: 0.7rem; font-weight: 800; padding: 2px 6px; border-radius: 4px; color: #fff; }
        .b-m { background: var(--male); } .b-f { background: var(--female); }
        .p-name { font-size: 1rem; font-weight: 800; color: var(--dark); }
        .p-info { font-size: 0.8rem; color: #64748b; font-weight: 600; }

        .btn { padding: 10px 14px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; font-size: 0.95rem; transition: 0.2s; display:inline-flex; align-items:center; justify-content:center; gap:5px; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-reserve { background: var(--reserved); color: #fff; }
        .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: var(--dark); }
        .btn-text { background: none; color: var(--primary); border: none; font-weight: 700; cursor: pointer; }
        .btn:hover { opacity: 0.9; }

        .btn-group { padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: #fff; }
        .empty-state { text-align: center; color: #cbd5e1; margin: auto; font-weight: 500; font-size: 0.9rem; padding: 20px; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-box { background: #fff; width: 500px; max-width: 90%; max-height: 90vh; border-radius: 16px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display:flex; flex-direction:column; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        label { display: block; font-size: 0.85rem; font-weight: 700; color: #64748b; margin-bottom: 5px; }

        .history-list { max-height: 400px; overflow-y: auto; }
        .history-item { padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 0.95rem; opacity: 0; transition: opacity 0.3s, bottom 0.3s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        .info-content { overflow-y: auto; text-align: left; line-height: 1.6; color: #334155; font-size: 0.95rem; padding-right: 5px; }
        .algo-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">BM</div>
    <div class="h-btn-group">
        <button class="h-btn" onclick="openInfoModal()">â“</button>
        <button class="h-btn" onclick="openHistory()">ğŸ“œ ê¸°ë¡</button>
        <button class="h-btn primary" onclick="addCourt()">+ ì½”íŠ¸</button>
        <button class="h-btn" onclick="openSettings()">âš™ï¸ ì„¤ì •</button>
    </div>
</div>

<div class="main-container">
    <!-- ëŒ€ê¸°ì‹¤ -->
    <div class="waiting-court">
        <div class="wc-header">
            <div class="wc-title-row">
                <span>ëŒ€ê¸°ì‹¤ (<span id="waitCount">0</span>)</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-text" onclick="openBulkPModal()">+ ì¼ê´„</button>
                    <button class="btn-text" onclick="openPModal()">+ ê°œë³„</button>
                </div>
            </div>
            <input type="text" id="searchInput" class="search-input" placeholder="ì´ë¦„ ê²€ìƒ‰..." onkeyup="render()">
            <div style="display:flex; justify-content:space-between; padding: 2px 10px; font-size:0.7rem; font-weight:800; color:#94a3b8; letter-spacing:0.5px; border-bottom:1px solid #f1f5f9;">
                <span>ì„±ë³„ / ì´ë¦„</span>
                <span>ì½• / ê¸‰ìˆ˜ / ê²½ê¸°ìˆ˜</span>
            </div>
        </div>
        <div id="waitList" class="wc-list"></div>
    </div>

    <!-- ì½”íŠ¸ ì˜ì—­ -->
    <div class="court-area">
        <div id="courtGrid" class="court-grid"></div>
    </div>
</div>

<div id="toast">ì•Œë¦¼ ë©”ì‹œì§€</div>
<input type="file" id="fileInput" style="display:none" onchange="importData(this)">

<!-- ì„ ìˆ˜ ë“±ë¡ ëª¨ë‹¬ -->
<div id="pModal" class="modal"><div class="modal-box">
    <h3 id="pModalTitle" style="margin-top:0;">ì„ ìˆ˜ ë“±ë¡</h3>
    <input type="text" id="pName" placeholder="ì´ë¦„ ì…ë ¥">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>ì„±ë³„</label><select id="pGen"><option value="M">ë‚¨ì„±</option><option value="F">ì—¬ì„±</option></select></div>
        <div><label>ê¸‰ìˆ˜</label><select id="pTier"><option value="5">Aì¡°</option><option value="4">Bì¡°</option><option value="3">Cì¡°</option><option value="2">Dì¡°</option><option value="1">Eì¡°</option><option value="0" selected>Fì¡°</option></select></div>
    </div>
    <label>ì´ˆê¸° ê²Œì„ ìˆ˜ (ì§€ê° ì‹œ ì¡°ì •, í˜„ì¬ í‰ê· -1 ìë™ê³„ì‚°)</label>
    <input type="number" id="pGames" value="0">
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn btn-primary" style="flex:1" onclick="savePlayer()">ì €ì¥</button>
        <button class="btn btn-outline" style="flex:1" onclick="closePModal()">ì·¨ì†Œ</button>
    </div>
    <button class="btn-text" style="width:100%; margin-top:15px; color:var(--danger)" onclick="deletePlayer()">ì„ ìˆ˜ ì‚­ì œ</button>
</div></div>

<!-- ì¼ê´„ ë“±ë¡ ëª¨ë‹¬ -->
<div id="bulkPModal" class="modal"><div class="modal-box">
    <h3 style="margin-top:0;">ì„ ìˆ˜ ì¼ê´„ ë“±ë¡</h3>
    <p style="font-size:0.85rem; color:#64748b; margin-bottom:10px;">ì´ë¦„ì„ ì¤„ë°”ê¿ˆ(Enter)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”.</p>
    <textarea id="bulkNames" style="width:100%; height:150px; padding:12px; border:1px solid var(--border); border-radius:8px; resize:none; font-family:inherit; margin-bottom:10px;" placeholder="ê¹€ì² ìˆ˜&#13;&#10;ì´ì˜í¬&#13;&#10;ë°•ì§€ì„±"></textarea>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>ì¼ê´„ ì„±ë³„</label><select id="bulkGen"><option value="M">ë‚¨ì„±</option><option value="F">ì—¬ì„±</option></select></div>
        <div><label>ì¼ê´„ ê¸‰ìˆ˜</label><select id="bulkTier"><option value="5">Aì¡°</option><option value="4">Bì¡°</option><option value="3">Cì¡°</option><option value="2">Dì¡°</option><option value="1">Eì¡°</option><option value="0" selected>Fì¡°</option></select></div>
    </div>
    
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn btn-primary" style="flex:1" onclick="saveBulkPlayers()">ì¼ê´„ ì €ì¥</button>
        <button class="btn btn-outline" style="flex:1" onclick="closeBulkPModal()">ì·¨ì†Œ</button>
    </div>
</div></div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" class="modal"><div class="modal-box">
    <h3 style="margin-top:0;">âš™ï¸ ì„¤ì • ë° ê´€ë¦¬</h3>
    <div style="display:grid; gap:10px;">
        <button class="btn btn-success" onclick="resetGamesOnly()">ğŸ“… ìƒˆ ëª¨ì„ ì‹œì‘ (ì„ ìˆ˜ ìœ ì§€/ê¸°ë¡ ì´ˆê¸°í™”)</button>
        <div style="height:1px; background:#eee; margin:5px 0;"></div>
        <button class="btn btn-outline" onclick="exportData()">ğŸ’¾ ë°ì´í„° ë°±ì—… (ë‹¤ìš´ë¡œë“œ)</button>
        <button class="btn btn-outline" onclick="triggerImport()">ğŸ“‚ ë°ì´í„° ë³µêµ¬ (íŒŒì¼ì—´ê¸°)</button>
        <div style="height:1px; background:#eee; margin:5px 0;"></div>
        <button class="btn btn-danger" onclick="resetAll()">âš  ë°ì´í„° ì „ì²´ ì´ˆê¸°í™” (ê³µì¥ì´ˆê¸°í™”)</button>
    </div>
    <button class="btn btn-outline" style="margin-top:20px;" onclick="closeSettings()">ë‹«ê¸°</button>
</div></div>

<!-- ë„ì›€ë§ ëª¨ë‹¬ -->
<div id="infoModal" class="modal"><div class="modal-box">
    <h3 style="margin-top:0;">â„¹ï¸ ë„ì›€ë§</h3>
    <div class="info-content">
        <ul style="padding-left: 20px; margin: 0; list-style-type: disc;">
            <li><strong>ì„ ìˆ˜ ë“±ë¡:</strong> '+ ê°œë³„' ë˜ëŠ” '+ ì¼ê´„' ì‚¬ìš©.</li>
            <li><strong>ìë™ ë§¤ì¹­:</strong> <strong>[âš¡ ìë™ ë§¤ì¹­]</strong> í´ë¦­ ì‹œ 4ëª… ì„ ë°œ.</li>
            <li><strong>ìˆ˜ë™ ë§¤ì¹­:</strong> <strong>[ìˆ˜ë™]</strong> ë²„íŠ¼ìœ¼ë¡œ 4ëª… ì§ì ‘ ì„ íƒ.</li>
            <li><strong>ì„ ìˆ˜ êµì²´:</strong> ë°°ì¹˜ëœ ì„ ìˆ˜ í´ë¦­ ì‹œ ëŒ€ê¸°ìì™€ êµì²´.</li>
            <li><strong>ìŠ¹ê³„ ê¸°ëŠ¥:</strong> ë‹¤ìŒ ì˜ˆì•½ì ì¡´ì¬ ì‹œ 'ê²Œì„ ì¢…ë£Œ' í›„ ìë™ ì…ì¥.</li>
        </ul>
        <div style="margin-top:15px;">
            <strong>âš™ï¸ ì•Œê³ ë¦¬ì¦˜ ìš°ì„ ìˆœìœ„</strong>
            <div class="algo-box" style="margin-top:5px;">
                1. ê²Œì„ ìˆ˜(G) ì ì€ ìˆœ<br>
                2. (ë™ì  ì‹œ) ëœë¤ ì…”í”Œ<br>
                3. íŒŒíŠ¸ë„ˆ ì¤‘ë³µ íšŸìˆ˜ ë‚®ì€ ì¡°í•©<br>
                4. íŒ€ ë°¸ëŸ°ìŠ¤ ê· í˜•
            </div>
        </div>
    </div>
    <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeInfoModal()">ë‹«ê¸°</button>
</div></div>

<!-- ìˆ˜ë™ ë§¤ì¹­ ëª¨ë‹¬ -->
<div id="manualModal" class="modal"><div class="modal-box" style="height:80vh;">
    <h3 style="margin-top:0;">ìˆ˜ë™ ë§¤ì¹­ (4ëª… ì„ íƒ)</h3>
    <div style="margin-bottom:10px; font-weight:bold; color:var(--primary);">ì„ íƒë¨: <span id="manualSelCount">0</span> / 4</div>
    <div id="manualList" class="wc-list" style="border:1px solid #eee; border-radius:8px;"></div>
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn btn-primary" style="flex:2" onclick="confirmManualMatch()">ë§¤ì¹­ í™•ì •</button>
        <button class="btn btn-outline" style="flex:1" onclick="closeManualModal()">ì·¨ì†Œ</button>
    </div>
</div></div>

<!-- ê²½ê¸° ê¸°ë¡ ëª¨ë‹¬ -->
<div id="hModal" class="modal"><div class="modal-box">
    <h3 style="margin-top:0">ê²½ê¸° ê¸°ë¡ (ìµœì‹ ìˆœ)</h3>
    <div id="historyList" class="history-list"></div>
    <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeHModal()">ë‹«ê¸°</button>
</div></div>

<!-- ì„ ìˆ˜ êµì²´ ëª¨ë‹¬ -->
<div id="swapModal" class="modal"><div class="modal-box">
    <h3 style="margin-top:0">ì„ ìˆ˜ êµì²´</h3>
    <div id="swapList" class="wc-list" style="max-height:300px; border:1px solid #eee; border-radius:8px;"></div>
    <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeSwapModal()">ë‹«ê¸°</button>
</div></div>

<!-- â˜… IOS Fix: ê³µí†µ í™•ì¸(Confirm) ëª¨ë‹¬ (window.confirm ëŒ€ì²´) â˜… -->
<div id="confirmModal" class="modal" style="z-index: 2000;">
    <div class="modal-box" style="width: 350px;">
        <h3 style="margin-top:0;">âš ï¸ í™•ì¸</h3>
        <p id="confirmMsg" style="white-space: pre-wrap; margin-bottom: 20px; line-height: 1.5; color:#334155;">ë‚´ìš©</p>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" style="flex:1" onclick="executeConfirm()">ì‹¤í–‰</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeConfirmModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    // --- Data ---
    let players = JSON.parse(localStorage.getItem('bm_p_v13')) || [];
    let courts = JSON.parse(localStorage.getItem('bm_c_v13')) || [{id: 1, type: 'A', active: [], next: [], startTime: null}];
    let history = JSON.parse(localStorage.getItem('bm_h_v13')) || [];
    const tiers = ["Fì¡°", "Eì¡°", "Dì¡°", "Cì¡°", "Bì¡°", "Aì¡°"];

    let editPId = null;
    let swapTarget = null;
    let manualTargetCId = null;
    let manualSelected = new Set();

    // --- Custom Confirm Logic (iOS Fix) ---
    let onConfirmAction = null;

    function showConfirmModal(msg, callback) {
        document.getElementById('confirmMsg').innerText = msg;
        onConfirmAction = callback; 
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function executeConfirm() {
        if (onConfirmAction) {
            onConfirmAction(); 
            onConfirmAction = null;
        }
        closeConfirmModal();
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        onConfirmAction = null;
    }

    // --- Save & Load ---
    function save() {
        localStorage.setItem('bm_p_v13', JSON.stringify(players));
        localStorage.setItem('bm_c_v13', JSON.stringify(courts));
        localStorage.setItem('bm_h_v13', JSON.stringify(history));
    }

    function showToast(msg) {
        const t = document.getElementById("toast"); t.innerText = msg; t.className = "show";
        setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
    }

    // --- Data Management Functions (Refactored for iOS) ---
    
    // 1. ì „ì²´ ì´ˆê¸°í™”
    function resetAll() { 
        showConfirmModal("âš  ëª¨ë“  ì„ ìˆ˜ ë°ì´í„°ì™€ ê¸°ë¡ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
            localStorage.clear(); 
            location.reload(); 
        });
    }

    // 2. ìƒˆ ëª¨ì„ ì‹œì‘
    function resetGamesOnly() {
        showConfirmModal("ğŸ“… ì„ ìˆ˜ ëª…ë‹¨ì€ ìœ ì§€í•˜ê³ ,\nê²Œì„ ìˆ˜ì™€ ê²½ê¸° ê¸°ë¡ë§Œ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìƒˆë¡œìš´ ëª¨ì„ ì‹œì‘ ì‹œ ê¶Œì¥)", () => {
            // ì½”íŠ¸ ìƒíƒœ ë¹„ìš°ê¸°
            courts.forEach(c => { 
                c.active = []; 
                c.next = []; 
                c.startTime = null; 
            });
            
            // ì„ ìˆ˜ ìƒíƒœ ì´ˆê¸°í™”
            players.forEach(p => { 
                p.games = 0; 
                p.status = 'waiting'; 
                p.lastTime = 0; 
            });
            
            // ê¸°ë¡ ë°°ì—´ ë¹„ìš°ê¸° (ë©”ëª¨ë¦¬ ì£¼ì†Œ ìœ ì§€)
            history.length = 0;
            
            save(); 
            render(); 
            closeSettings(); 
            showToast("ìƒˆ ëª¨ì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    }

    // 3. ì½”íŠ¸ ì‚­ì œ
    function delCourt(id) { 
        showConfirmModal("ì´ ì½”íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë°°ì •ëœ ì„ ìˆ˜ë“¤ì€ ëŒ€ê¸°ì‹¤ë¡œ ì´ë™í•©ë‹ˆë‹¤)", () => {
            const c = courts.find(x => x.id === id);
            if (c) {
                [...c.active, ...c.next].forEach(p => {
                    const player = players.find(x => x.id === p.id);
                    if (player) player.status = 'waiting';
                });
                courts = courts.filter(x => x.id !== id);
                save(); 
                render();
                showToast("ì½”íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    // 4. ì„ ìˆ˜ ì‚­ì œ
    function deletePlayer() { 
        showConfirmModal("ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œ í›„ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)", () => {
            players = players.filter(x => x.id !== editPId);
            save(); 
            closePModal(); 
            render(); 
            showToast("ì„ ìˆ˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    }

    // --- Core: Auto Match ---
    function matchCourt(cId) {
        const court = courts.find(c => c.id === cId);
        if(court.next.length > 0) return showToast("ì´ë¯¸ ë‹¤ìŒ ê²½ê¸°ê°€ ì˜ˆì•½ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");

        let pool = players.filter(p => p.status === 'waiting');
        const type = court.type;

        let genderPool = [];
        if(type === 'M') genderPool = pool.filter(p => p.gender === 'M');
        else if(type === 'F') genderPool = pool.filter(p => p.gender === 'F');
        else if(type === 'X') {
            const m = pool.filter(p => p.gender === 'M');
            const f = pool.filter(p => p.gender === 'F');
            if(m.length < 2 || f.length < 2) return showToast("í˜¼ë³µ ì¸ì›(ë‚¨2, ì—¬2)ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            genderPool = pool;
        } else {
            genderPool = pool;
        }

        if(type !== 'X' && genderPool.length < 4) return showToast("ëŒ€ê¸° ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

        let selected = [];
        if(type === 'X') {
            const m = pool.filter(p => p.gender === 'M').sort((a,b)=>a.games-b.games);
            const f = pool.filter(p => p.gender === 'F').sort((a,b)=>a.games-b.games);
            const sm = shuffleByGameCount(m);
            const sf = shuffleByGameCount(f);
            selected = [...sm.slice(0,2), ...sf.slice(0,2)];
        } else {
            genderPool.sort((a,b) => a.games - b.games);
            const shuffled = shuffleByGameCount(genderPool);
            selected = shuffled.slice(0, 4);
        }

        applyMatch(cId, selected, 'next');
    }

    // --- Core: Manual Match ---
    function openManualMatch(cId) {
        const court = courts.find(c => c.id === cId);
        if(court.active.length > 0 && court.next.length > 0) return showToast("ì˜ˆì•½ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤.");
        manualTargetCId = cId; manualSelected.clear(); renderManualList();
        document.getElementById('manualModal').style.display = 'flex';
    }

    function renderManualList() {
        const list = document.getElementById('manualList'); list.innerHTML = '';
        const waiters = players.filter(p => p.status === 'waiting').sort((a,b) => a.games - b.games || a.lastTime - b.lastTime);
        document.getElementById('manualSelCount').innerText = manualSelected.size;
        
        waiters.forEach(p => {
            const isSel = manualSelected.has(p.id);
            list.innerHTML += `
            <div class="player-chip waiting-chip manual-chip ${isSel?'selected':''}" onclick="toggleManualSelect(${p.id})">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="badge ${p.gender==='M'?'b-m':'b-f'}">${p.gender === 'M' ? 'ë‚¨' : 'ì—¬'}</span> <span>${p.name}</span>
                </div>
                <div><span class="p-info">${tiers[p.tier]}</span> <span class="badge" style="background:#eee; color:#555;">${p.games}íšŒ</span></div>
            </div>`;
        });
    }

    function toggleManualSelect(pId) {
        if(manualSelected.has(pId)) manualSelected.delete(pId);
        else { if(manualSelected.size >= 4) return showToast("4ëª…ê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤."); manualSelected.add(pId); }
        renderManualList();
    }

    function confirmManualMatch() {
        if(manualSelected.size !== 4) return showToast("4ëª…ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
        const selectedIds = Array.from(manualSelected);
        const selectedPlayers = selectedIds.map(id => players.find(p => p.id === id));
        const court = courts.find(c => c.id === manualTargetCId);
        const targetArea = (court.active.length === 0) ? 'active' : 'next';
        applyMatch(manualTargetCId, selectedPlayers, targetArea);
        closeManualModal();
    }

    function closeManualModal() { document.getElementById('manualModal').style.display='none'; }

    // --- Apply Match ---
    function applyMatch(cId, selectedPlayers, targetArea) {
        const court = courts.find(c => c.id === cId);
        selectedPlayers.sort((a,b) => b.tier - a.tier);

        const ms = selectedPlayers.filter(p=>p.gender==='M');
        const fs = selectedPlayers.filter(p=>p.gender==='F');
        let bestTeam = [];

        if(ms.length === 2 && fs.length === 2) {
             const s1 = getScore(ms[0].id, fs[0].id) + getScore(ms[1].id, fs[1].id);
             const s2 = getScore(ms[0].id, fs[1].id) + getScore(ms[1].id, fs[0].id);
             bestTeam = (s1 <= s2) ? [ms[0], fs[0], ms[1], fs[1]] : [ms[0], fs[1], ms[1], fs[0]];
        } else {
             const sA = getScore(selectedPlayers[0].id, selectedPlayers[3].id) + getScore(selectedPlayers[1].id, selectedPlayers[2].id);
             const sB = getScore(selectedPlayers[0].id, selectedPlayers[2].id) + getScore(selectedPlayers[1].id, selectedPlayers[3].id);
             bestTeam = (sA <= sB) ? [selectedPlayers[0], selectedPlayers[3], selectedPlayers[1], selectedPlayers[2]] 
                                   : [selectedPlayers[0], selectedPlayers[2], selectedPlayers[1], selectedPlayers[3]];
        }

        court[targetArea] = bestTeam;
        bestTeam.forEach(p => {
            const player = players.find(x=>x.id===p.id);
            if(player) player.status = (targetArea === 'active' ? 'playing' : 'reserved');
        });

        if(targetArea === 'active') court.startTime = Date.now();
        save(); render();
    }

    // --- Game End / Cancel ---
    function endGame(cId) {
        const court = courts.find(c => c.id === cId);
        const now = Date.now();

        if(court.active.length > 0) {
            const pIds = court.active.map(p => p.id);
            const pNames = court.active.map(p => p.name).join(', ');
            const sTime = court.startTime || (now - 10*60*1000); 

            history.unshift({ startTime: sTime, endTime: now, cId: cId, pIds: pIds, names: pNames });
            if(history.length > 200) history.pop();

            court.active.forEach(p => {
                const target = players.find(x => x.id === p.id);
                if(target) { target.games++; target.lastTime = now; target.status = 'waiting'; }
            });
        }

        if(court.next.length > 0) {
            court.active = [...court.next];
            court.next = [];
            court.active.forEach(p => players.find(x=>x.id===p.id).status = 'playing');
            court.startTime = Date.now();
        } else {
            court.active = [];
            court.startTime = null;
        }
        save(); render();
    }

    function cancelNext(cId) {
        const court = courts.find(c => c.id === cId);
        court.next.forEach(p => players.find(x=>x.id===p.id).status = 'waiting');
        court.next = [];
        save(); render();
    }

    // --- Helpers ---
    function shuffleByGameCount(list) {
        const groups = {};
        list.forEach(p => { if(!groups[p.games]) groups[p.games] = []; groups[p.games].push(p); });
        let result = [];
        Object.keys(groups).sort((a,b)=>a-b).forEach(g => {
            const group = groups[g];
            for (let i = group.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [group[i], group[j]] = [group[j], group[i]]; }
            result = [...result, ...group];
        });
        return result;
    }
    
    function getScore(id1, id2) {
        let count = 0;
        history.forEach(h => {
            if(!h.pIds) return;
            const t1 = [h.pIds[0], h.pIds[1]]; const t2 = [h.pIds[2], h.pIds[3]];
            if((t1.includes(id1) && t1.includes(id2)) || (t2.includes(id1) && t2.includes(id2))) count++;
        });
        return count;
    }
    function getAverageGames() {
        if(players.length === 0) return 0;
        const total = players.reduce((sum, p) => sum + p.games, 0);
        return Math.max(0, Math.floor(total / players.length) - 1);
    }
    function formatTime(timestamp) {
        const d = new Date(timestamp);
        return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    }

    // --- Modal Controls & Export ---
    function openSettings() { document.getElementById('settingsModal').style.display='flex'; }
    function closeSettings() { document.getElementById('settingsModal').style.display='none'; }
    function openInfoModal() { document.getElementById('infoModal').style.display='flex'; }
    function closeInfoModal() { document.getElementById('infoModal').style.display='none'; }

    function exportData() {
        const data = { players, courts, history, version: 'v13_pro_ios' };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url;
        const date = new Date().toISOString().slice(0,10); a.download = `BM_Backup_${date}.json`;
        a.click(); showToast("ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ");
    }
    function triggerImport() { document.getElementById('fileInput').click(); }
    function importData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.players && data.courts) {
                    players = data.players; courts = data.courts; history = data.history || [];
                    save(); render(); showToast("ë°ì´í„° ë³µêµ¬ ì™„ë£Œ!");
                }
            } catch(err) { showToast("íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
        };
        reader.readAsText(file); input.value = '';
    }

    // --- Timer ---
    setInterval(() => {
        courts.forEach(c => {
            const el = document.getElementById(`timer-${c.id}`);
            if(c.active.length > 0 && c.startTime) {
                const diff = Math.floor((Date.now() - c.startTime) / 1000);
                const min = Math.floor(diff / 60); const sec = diff % 60;
                if(el) {
                    el.innerText = `â± ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                    el.style.display = 'flex';
                }
            } else {
                if(el) el.style.display = 'none';
            }
        });
    }, 1000);

    // --- Render Logic ---
    function render() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        
        const renderWaitList = (containerId) => {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = '';
            
            let list = players.filter(p => p.name.toLowerCase().includes(keyword));
            
            list.sort((a,b) => {
                const statusScore = { 'waiting': 0, 'reserved': 1, 'playing': 2 };
                if(statusScore[a.status] !== statusScore[b.status]) return statusScore[a.status] - statusScore[b.status];
                if(a.games !== b.games) return a.games - b.games;
                return a.lastTime - b.lastTime;
            });

            if(containerId === 'waitList') {
                const waitingCount = list.filter(p => p.status === 'waiting').length;
                document.getElementById('waitCount').innerText = `${waitingCount}/${list.length}`;
            }

            list.forEach(p => {
                const scStyle = p.shuttlecock ? 'opacity:1; filter:none' : 'opacity:0.2; filter:grayscale(100%)';
                
                let statusBadge = '';
                let itemStyle = '';
                if(p.status === 'playing') {
                    statusBadge = `<span class="badge" style="background:var(--primary); font-size:0.6rem; margin-left:4px;">ê²Œì„ì¤‘</span>`;
                    itemStyle = 'opacity:0.7; background:#f1f5f9; border-color:transparent;';
                } else if (p.status === 'reserved') {
                    statusBadge = `<span class="badge" style="background:var(--reserved); font-size:0.6rem; margin-left:4px;">ì˜ˆì•½ë¨</span>`;
                    itemStyle = 'background:#fffbeb; border-color:#fcd34d;';
                }

                container.innerHTML += `
                <div class="player-chip waiting-chip" onclick="openPModal(${p.id})" style="${itemStyle}">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="badge ${p.gender==='M'?'b-m':'b-f'}">${p.gender === 'M' ? 'ë‚¨' : 'ì—¬'}</span> <span class="p-name">${p.name}</span>
                        ${statusBadge}
                    </div>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <span onclick="event.stopPropagation(); toggleShuttlecock(${p.id})" style="cursor:pointer; font-size:1.1rem; ${scStyle}" title="ì…”í‹€ì½•">ğŸ¸</span>
                        <span class="p-info" style="margin-right:4px;">${tiers[p.tier]}</span> <span class="badge" style="background:#e2e8f0; color:#475569;">${p.games}íšŒ</span>
                    </div>
                </div>`;
            });
        };
        renderWaitList('waitList');

        const cg = document.getElementById('courtGrid'); cg.innerHTML = '';
        courts.forEach((c, idx) => {
            const hasActive = c.active.length > 0;
            const hasNext = c.next.length > 0;
            const typeSel = `<select class="type-select" onchange="setType(${c.id}, this.value)" ${hasActive?'disabled':''}>
                <option value="A" ${c.type=='A'?'selected':''}>ììœ¨</option>
                <option value="M" ${c.type=='M'?'selected':''}>ë‚¨ë³µ</option>
                <option value="F" ${c.type=='F'?'selected':''}>ì—¬ë³µ</option>
                <option value="X" ${c.type=='X'?'selected':''}>í˜¼ë³µ</option>
            </select>`;

            let activeHTML = hasActive ? `<div class="player-grid">${c.active.map((p,i)=>renderChip(c,'active',i)).join('')}</div>` : `<div class="empty-state">ğŸ¸ ë§¤ì¹­ ëŒ€ê¸°</div>`;
            
            let nextHTML = '';
            if(hasNext) {
                nextHTML = `<div class="player-grid">${c.next.map((p,i)=>renderChip(c,'next',i,'next-chip')).join('')}</div>
                            <button class="btn btn-outline" style="margin-top:8px; width:100%; font-size:0.8rem;" onclick="cancelNext(${c.id})">ì˜ˆì•½ ì·¨ì†Œ</button>`;
            } else {
                 nextHTML = `
                 <div style="display:flex; gap:5px;">
                     <button class="btn btn-reserve" style="flex:2" onclick="matchCourt(${c.id})">${hasActive?'ë‹¤ìŒ ì˜ˆì•½':'âš¡ ìë™ ë§¤ì¹­'}</button>
                     <button class="btn btn-outline" style="flex:1" onclick="openManualMatch(${c.id})">ìˆ˜ë™</button>
                 </div>`;
            }

            let mainBtnHTML = '';
            if (hasActive) {
                mainBtnHTML = `<button class="btn btn-danger" style="width:100%" onclick="endGame(${c.id})">ê²Œì„ ì¢…ë£Œ ${hasNext ? '(ìŠ¹ê³„)' : ''}</button>`;
            } else if (hasNext) {
                mainBtnHTML = `<button class="btn btn-primary" style="width:100%" onclick="endGame(${c.id})">ê²Œì„ ì‹œì‘ (ì…ì¥)</button>`;
            }

            cg.innerHTML += `
            <div class="court-card">
                <div class="cc-header">
                    <span style="font-weight:800; font-size:1.1rem;">ì½”íŠ¸ ${idx+1}</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        ${typeSel} <span onclick="delCourt(${c.id})" style="cursor:pointer; color:#ccc;">Ã—</span>
                    </div>
                </div>
                <div class="game-section">
                    <div class="section-label">
                        <span>ì§„í–‰ ì¤‘ <span style="color:${hasActive?'#2563eb':'#cbd5e1'}">â—</span></span>
                        <span id="timer-${c.id}" class="timer-badge">â± 00:00</span>
                    </div>
                    ${activeHTML}
                </div>
                <div class="next-section">
                    <div class="section-label">ë‹¤ìŒ ëŒ€ê¸° <span style="color:${hasNext?'#f59e0b':'#cbd5e1'}">â—</span></div>
                    ${nextHTML}
                </div>
                ${mainBtnHTML ? `<div class="btn-group">${mainBtnHTML}</div>` : ''}
            </div>`;
        });
    }

    function renderChip(court, area, idx, cls='') {
        const p = court[area][idx];
        return `<div class="player-chip ${cls}" onclick="openSwap(${court.id}, '${area}', ${idx})">
            <span class="badge ${p.gender==='M'?'b-m':'b-f'}">${p.gender === 'M' ? 'ë‚¨' : 'ì—¬'}</span> <span class="p-name">${p.name}</span> <span class="p-info">${tiers[p.tier]}</span>
        </div>`;
    }

    function setType(id, val) { courts.find(c=>c.id===id).type = val; save(); }
    function addCourt() { courts.push({id:Date.now(), type:'A', active:[], next:[], startTime:null}); save(); render(); }
    
    function openPModal(id=null) { 
        editPId = id; const p = players.find(x=>x.id===id);
        document.getElementById('pModalTitle').innerText = id ? "ì„ ìˆ˜ ì •ë³´ ìˆ˜ì •" : "ì„ ìˆ˜ ë“±ë¡";
        document.getElementById('pName').value = id ? p.name : "";
        document.getElementById('pGen').value = id ? p.gender : "M";
        document.getElementById('pTier').value = id ? p.tier : "0";
        document.getElementById('pGames').value = id ? p.games : getAverageGames();
        document.getElementById('pModal').style.display = 'flex';
        document.getElementById('pName').focus();
    }
    function closePModal() { document.getElementById('pModal').style.display='none'; }
    function openBulkPModal() {
        document.getElementById('bulkNames').value = '';
        document.getElementById('bulkPModal').style.display = 'flex';
        document.getElementById('bulkNames').focus();
    }
    function closeBulkPModal() { document.getElementById('bulkPModal').style.display='none'; }
    
    function saveBulkPlayers() {
        const text = document.getElementById('bulkNames').value.trim();
        if(!text) return showToast("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        if(lines.length === 0) return;

        const tier = parseInt(document.getElementById('bulkTier').value);
        const gen = document.getElementById('bulkGen').value;
        const games = getAverageGames(); 

        let count = 0;
        lines.forEach((name, idx) => {
            players.push({
                id: Date.now() + idx,
                name: name,
                gender: gen,
                tier: tier,
                games: games,
                lastTime: 0,
                status: 'waiting',
                shuttlecock: false
            });
            count++;
        });

        save(); closeBulkPModal(); render(); showToast(`${count}ëª… ë“±ë¡ ì™„ë£Œ`);
    }

    function savePlayer() {
        const name = document.getElementById('pName').value.trim(); if(!name) return showToast("ì´ë¦„ í•„ìˆ˜");
        const tier = parseInt(document.getElementById('pTier').value);
        const gen = document.getElementById('pGen').value;
        const games = parseInt(document.getElementById('pGames').value) || 0;
        if(editPId) { const p=players.find(x=>x.id===editPId); p.name=name; p.tier=tier; p.gender=gen; p.games=games; }
        else { players.push({id:Date.now(), name, gender:gen, tier, games:games, lastTime:0, status:'waiting', shuttlecock:false}); }
        save(); closePModal(); render(); showToast("ì €ì¥ë¨");
    }
    function toggleShuttlecock(id) {
        const p = players.find(x => x.id === id);
        if (p) { p.shuttlecock = !p.shuttlecock; save(); render(); }
    }

    function openHistory() {
        const hList = document.getElementById('historyList'); hList.innerHTML='';
        const courtMap = {}; courts.forEach((c, i) => courtMap[c.id] = i + 1);

        if(history.length === 0) {
            hList.innerHTML = '<div class="empty-state">ê¸°ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        history.forEach(h => {
            const startStr = formatTime(h.startTime);
            const endStr = formatTime(h.endTime);
            const durationMin = Math.floor((h.endTime - h.startTime) / 60000);
            const courtNum = courtMap[h.cId] ? `ì½”íŠ¸ ${courtMap[h.cId]}` : 'ì‚­ì œëœ ì½”íŠ¸';
            
            hList.innerHTML += `<div class="history-item">
                <div style="font-size:0.75rem; color:#64748b; font-weight:700; margin-bottom:4px; display:flex; justify-content:space-between;">
                    <span><span style="color:#2563eb;">${courtNum}</span> | ${startStr} ~ ${endStr}</span>
                    <span style="background:#f1f5f9; padding:2px 6px; border-radius:4px;">${durationMin}ë¶„</span>
                </div>
                <div style="font-weight:600; font-size:0.95rem;">${h.names}</div>
            </div>`;
        });
        document.getElementById('hModal').style.display='flex';
    }
    function closeHModal() { document.getElementById('hModal').style.display='none'; }

    function openSwap(cId, area, idx) {
        swapTarget = {cId, area, idx};
        const list = document.getElementById('swapList'); list.innerHTML='';
        players.filter(p=>p.status==='waiting').sort((a,b)=>a.games-b.games).forEach(p=>{
            list.innerHTML += `<div class="player-chip waiting-chip" onclick="doSwap(${p.id})">
                <span class="badge ${p.gender==='M'?'b-m':'b-f'}">${p.gender === 'M' ? 'ë‚¨' : 'ì—¬'}</span> <span class="p-name">${p.name}</span>
            </div>`;
        });
        document.getElementById('swapModal').style.display='flex';
    }
    function doSwap(pId) {
        const c = courts.find(x=>x.id===swapTarget.cId);
        const oldP = c[swapTarget.area][swapTarget.idx];
        players.find(x=>x.id===oldP.id).status='waiting';
        players.find(x=>x.id===pId).status = (swapTarget.area==='active')?'playing':'reserved';
        c[swapTarget.area][swapTarget.idx] = players.find(x=>x.id===pId);
        save(); closeSwapModal(); render(); showToast("êµì²´ ì™„ë£Œ");
    }
    function closeSwapModal() { document.getElementById('swapModal').style.display='none'; }

    render();
</script>
</body>
</html>